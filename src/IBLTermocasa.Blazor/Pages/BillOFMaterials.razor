@page "/bill-of-materials"

@attribute [Authorize(IBLTermocasaPermissions.BillOFMaterials.Default)]
@using IBLTermocasa.BillOfMaterials
@using IBLTermocasa.Localization
@using IBLTermocasa.Permissions
@using IBLTermocasa.RequestForQuotations
@using Microsoft.AspNetCore.Authorization
@using Volo.Abp.AspNetCore.Components.Messages
@using Volo.Abp.AspNetCore.Components.Web
@using Volo.Abp.AspNetCore.Components.Web.Theming.Layout
@using Volo.Abp.Http.Client
@using Color = MudBlazor.Color
@using Margin = MudBlazor.Margin
@using MudBlazor
@using IBLTermocasa.Blazor.Components.BillOfMaterial
@inherits IBLTermocasaComponentBase
@inject IBillOfMaterialsAppService BillOFMaterialsAppService
@inject IRequestForQuotationsAppService RequestForQuotationsAppService

@inject IUiMessageService UiMessageService
@inject AbpBlazorMessageLocalizerHelper<IBLTermocasaResource> LH
@inject IRemoteServiceConfigurationProvider RemoteServiceConfigurationProvider
@inject NavigationManager NavigationManager

@* ************************* PAGE HEADER ************************* *@
<PageHeader Title="@L["BillOFMaterials"]" BreadcrumbItems="BreadcrumbItems" Toolbar="Toolbar">

</PageHeader>

@* ************************* SEARCH ************************* *@
<MudCard Class="bg-white mb-3 scrollable-card">
    <MudCardContent>
        <MudGrid>
        <MudItem xs="12">
            <MudTextField T="string"
                          @bind-Value="Filter.FilterText"
                          AutoFocus="true"
                          Label="@L["Search"]"
                          Immediate="true"
                          Variant="Variant.Outlined" Margin="Margin.Dense"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Outlined.Search"
                          OnAdornmentClick="@GetBillOFMaterialsAsync">
            </MudTextField>
        </MudItem>
        <MudItem xs="12">
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       OnClick="@(() => ShowAdvancedFilters = !ShowAdvancedFilters)">
                @L["SeeAdvancedFilters"]
            </MudButton>
        </MudItem>
        @if (ShowAdvancedFilters)
        {
            <MudItem xs="12" sm="3">
                <MudTextField T="string"
                              Label="@L["Name"]"
                              Immediate="true"
                              Variant="Variant.Outlined" Margin="Margin.Dense"
                              ValueChanged="@(s => OnNameChangedAsync(s))">
                </MudTextField>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudTextField T="string"
                              Label="@L["RequestForQuotation"]"
                              Immediate="true"
                              Variant="Variant.Outlined" Margin="Margin.Dense"
                              ValueChanged="@(s => OnRequestForQuotationIdChangedAsync(s))">
                </MudTextField>
            </MudItem>
        }
        </MudGrid>
    </MudCardContent>
</MudCard>


@* ************************* DATA GRID ************************* *@

<MudCard>
    <MudCardContent>
        <MudDataGrid Items="BillOFMaterialList">
            <Columns>
                <PropertyColumn Property="x => x.Name" Title="@L["Name"]"/>
                <PropertyColumn Property="x => x.RequestForQuotationProperty.Name" Title="@L["RequestForQuotation"]"/>
            </Columns>
        </MudDataGrid>
    </MudCardContent>
</MudCard>

<ModalBillOfMaterialInput @ref="AddBillOfMaterialModal"
                          OnCancel="CloseModalBillOfMaterialAsync"
                          OnSave="SaveModalBillOfMaterialInputAsync"/>


@*<Card>
    <CardBody>        
        @if (SelectedBillOFMaterials.Any())
        {
            <div class="d-flex justify-content-between align-items-center mb-2">
                @if (AllBillOFMaterialsSelected)
                {
                    <p class="lead mb-0">
                        @L["AllItemsAreSelected", TotalCount]
                    </p>
                }
                else
                {
                    <p class="lead mb-0">
                        @if (SelectedBillOFMaterials.Count > 1)
                        {
                            @L["NumberOfItemsOnThisPageAreSelected", SelectedBillOFMaterials.Count]
                        }
                        else
                        {
                            @L["OneItemOnThisPageIsSelected"]
                        }
                    </p>
                }
                    
                <div>
                    @if ((SelectedBillOFMaterials.Count == PageSize || SelectedBillOFMaterials.Count == BillOFMaterialList.Count) && TotalCount > SelectedBillOFMaterials.Count)
                    {
                        if (!AllBillOFMaterialsSelected)
                        {
                            <Button Clicked="SelectAllItems" Class="mx-1 btn-outline-secondary">@L["SelectAllItems", TotalCount]</Button>
                        }
                        else
                        {
                            <Button Clicked="ClearSelection" Class="mx-1 btn-outline-secondary">@L["ClearSelection"]</Button>
                        }
                    }
                    
                    <Button Color="Color.Danger" Class="mx-1" Size="Size.Medium" Clicked="DeleteSelectedBillOFMaterialsAsync">
                        <Icon Name="@IconName.Delete" /> @L["Delete"]
                    </Button>
                </div>
            </div>
            
            <hr class="my-1 mx-0"/>
        }
        <DataGrid TItem="BillOFMaterialDto"
                  Data="BillOFMaterialList"
                  
                  SelectionMode="DataGridSelectionMode.Multiple"
                  SelectedRows="SelectedBillOFMaterials"
                  RowSelectable="@((args) => CanDeleteBillOFMaterial)"
                  SelectedRowsChanged="SelectedBillOFMaterialRowsChanged"
                  
                  
                  
                  ReadData="OnDataGridReadAsync"
                  TotalItems="TotalCount"
                  ShowPager="true"
                  Responsive="true"
                  PageSize="PageSize"
                  Class="datagrid-detail">
            <DataGridColumns>
                
                @if (CanDeleteBillOFMaterial)
                {
                    <DataGridMultiSelectColumn TItem="BillOFMaterialDto" Width="30px" Displayable="@(BillOFMaterialList.Any())"></DataGridMultiSelectColumn>
                }
                
                <DataGridEntityActionsColumn TItem="BillOFMaterialDto" @ref="@EntityActionsColumn">
                    <DisplayTemplate>
                        <EntityActions TItem="BillOFMaterialDto" EntityActionsColumn="@EntityActionsColumn">
                            <EntityAction TItem="BillOFMaterialDto"
                                          Visible="@CanEditBillOFMaterial"
                                          Clicked="async () => await OpenEditBillOFMaterialModalAsync(context)"
                                          Text="@L["Edit"]"></EntityAction>
                            <EntityAction TItem="BillOFMaterialDto"
                                          Visible="@CanDeleteBillOFMaterial"
                                          Clicked="() => DeleteBillOFMaterialAsync(context)"
                                          ConfirmationMessage="@(()=> L["DeleteConfirmationMessage"])"
                                          Text="@L["Delete"]"></EntityAction>

                        </EntityActions>
                    </DisplayTemplate>
                </DataGridEntityActionsColumn>
               
              <DataGridColumn TItem="BillOFMaterialDto"
                      Field="Name"
                      Caption="@L["Name"]">
              </DataGridColumn>

              <DataGridColumn TItem="BillOFMaterialDto"
                      Field="RequestForQuotationProperty.Name"
                      Caption="@L["RequestForQuotation"]">
              </DataGridColumn>

              <DataGridColumn TItem="BillOFMaterialDto"
                      Field="ListItems"
                      Caption="@L["ListItems"]">
              </DataGridColumn>

            </DataGridColumns>
            
            
        </DataGrid>
    </CardBody>
</Card>*@
<MudThemeProvider/>


